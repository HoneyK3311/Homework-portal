<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .details-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toggle-arrow { transition: transform 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading-indicator" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <div id="app" class="max-w-xl mx-auto p-4 opacity-0 transition-opacity duration-300">
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-gray-800"><span class="text-blue-600">{{ student_name }}</span> í•™ìƒ ë¦¬í¬íŠ¸</h1>
            <p id="student-info" class="text-gray-500 mt-2"></p>
        </header>
        <div class="bg-white rounded-xl shadow-md mb-6 overflow-hidden">
            <div id="attendance-header" class="p-6 cursor-pointer flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-16 h-16 mr-4"><canvas id="attendance-chart"></canvas></div>
                    <div><h2 class="text-xl font-bold">ğŸ“… ì¶œê²° í˜„í™©</h2><div id="attendance-summary-text" class="text-sm font-semibold"></div></div>
                </div>
                <svg class="w-6 h-6 text-gray-400 toggle-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="details-container"><div id="attendance-list" class="px-6 pb-6 pt-0 space-y-3"></div></div>
        </div>
        <div class="bg-white rounded-xl shadow-md mb-6 overflow-hidden">
             <div id="assignment-header" class="p-6 cursor-pointer flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-16 h-16 mr-4"><canvas id="assignment-chart"></canvas></div>
                    <div><h2 class="text-xl font-bold">ğŸ“š ê³¼ì œ ì œì¶œ í˜„í™©</h2><div id="assignment-summary-text" class="text-sm font-semibold"></div></div>
                </div>
                <svg class="w-6 h-6 text-gray-400 toggle-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="details-container"><div id="assignment-list" class="px-6 pb-6 pt-0 space-y-3"></div></div>
        </div>
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div id="clinic-header" class="p-6 cursor-pointer flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-16 h-16 mr-4"><canvas id="clinic-chart"></canvas></div>
                    <div><h2 class="text-xl font-bold">âœï¸ í´ë¦¬ë‹‰ í˜„í™©</h2><div id="clinic-summary-text" class="text-sm font-semibold"></div></div>
                </div>
                <svg class="w-6 h-6 text-gray-400 toggle-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="details-container"><div id="clinic-list" class="px-6 pb-6 pt-0 space-y-3"></div></div>
        </div>
        <div class="mt-8 text-center"><button id="logout-btn" class="bg-gray-500 text-white py-2 px-6 rounded-lg hover:bg-gray-600">ë¡œê·¸ì•„ì›ƒ</button></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingIndicator = document.getElementById('loading-indicator');
            const appContainer = document.getElementById('app');
            const getStatusBadge = (status, type) => {
                let color = 'gray';
                if (type === 'attendance') {
                    if (status === 'ì¶œì„' || status === 'ì°¸ì„') color = 'green'; if (status === 'ì§€ê°') color = 'yellow'; if (status === 'ê²°ì„') color = 'red';
                } else if (type === 'assignment') {
                    if (status === 'ì •ìƒì œì¶œ') color = 'green'; if (status === 'ì§€ê°ì œì¶œ') color = 'yellow'; if (status === 'ë¯¸ì œì¶œ' || status === 'ë°˜ë ¤') color = 'red'; if (status === 'í™•ì¸ì™„ë£Œ') color = 'blue';
                }
                return `<span class="font-bold text-${color}-600">${status}</span>`;
            };
            const createDoughnutChart = (canvasId, counts, colors, centerText) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: Object.values(counts), backgroundColor: Object.values(colors), borderWidth: 0 }], labels: Object.keys(counts) }, options: { cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: true } }, responsive: true, maintainAspectRatio: false },
                    plugins: [{ beforeDraw: function(chart) { const {width, height, ctx} = chart; ctx.restore(); const fontSize = (height / 80).toFixed(2); ctx.font = `bold ${fontSize}em sans-serif`; ctx.textBaseline = "middle"; const textX = Math.round((width - ctx.measureText(centerText).width) / 2); const textY = height / 2; ctx.fillText(centerText, textX, textY); ctx.save(); } }]
                });
            };
            try {
                const response = await fetch('/api/my_page_data');
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");

                document.getElementById('student-info').innerText = `í´ë˜ìŠ¤: ${data.student_info.í´ë˜ìŠ¤} | í•™ìƒë²ˆí˜¸: ${data.student_info.í•™ìƒì „í™”}`;
                const attSummary = data.attendance.summary;
                const attTotal = attSummary['ì´ì¼ìˆ˜'] || 0;
                const attPresent = attSummary['ì •ìƒ'] || 0;
                const attLate = attSummary['ì§€ê°'] || 0;
                const attAbsent = attSummary['ê²°ì„'] || 0;
                const attRate = Math.round(((attPresent + attLate) / attTotal || 0) * 100);
                document.getElementById('attendance-summary-text').innerHTML = `<span class="text-green-600">ì •ìƒ: ${attPresent}</span><span class="text-yellow-500 ml-2">ì§€ê°: ${attLate}</span><span class="text-red-500 ml-2">ê²°ì„: ${attAbsent}</span>`;
                createDoughnutChart('attendance-chart', { 'ì •ìƒ': attPresent, 'ì§€ê°': attLate, 'ê²°ì„': attAbsent }, { 'ì •ìƒ': '#16a34a', 'ì§€ê°': '#f59e0b', 'ê²°ì„': '#dc2626' }, `${attRate}%`);
                const attendanceList = document.getElementById('attendance-list');
                if (data.attendance.details.length > 0) {
                    attendanceList.innerHTML = data.attendance.details.map(item => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="text-gray-700">${item.date}</span>${getStatusBadge(item.status, 'attendance')}</div>`).join('');
                } else { attendanceList.innerHTML = '<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; }

                const hwSummary = data.assignments.summary;
                const hwTotalForRate = hwSummary['ì´ê³¼ì œ_ë¹„ìœ¨ê³„ì‚°ìš©'] || 0; // ë¹„ìœ¨ ê³„ì‚°ìš© ì´ëŸ‰ ì‚¬ìš©
                const hwOntime = hwSummary['ì •ìƒì œì¶œ'] || 0;
                const hwLate = hwSummary['ì§€ê°ì œì¶œ'] || 0;
                const hwUnsubmitted = hwSummary['ë¯¸ì œì¶œ'] || 0;
                const hwSubmittedRate = Math.round(((hwOntime + hwLate) / hwTotalForRate || 0) * 100); // ìˆ˜ì •ëœ ê³µì‹ ì ìš©
                
                document.getElementById('assignment-summary-text').innerHTML = `<span class="text-green-600">ì •ìƒ: ${hwOntime}</span><span class="text-yellow-500 ml-2">ì§€ê°: ${hwLate}</span><span class="text-red-500 ml-2">ë¯¸ì œì¶œ: ${hwUnsubmitted}</span>`;
                createDoughnutChart('assignment-chart', { 'ì •ìƒ': hwOntime, 'ì§€ê°': hwLate, 'ë¯¸ì œì¶œ': hwUnsubmitted }, { 'ì •ìƒ': '#16a34a', 'ì§€ê°': '#f59e0b', 'ë¯¸ì œì¶œ': '#dc2626' }, `${hwSubmittedRate}%`);
    
                const assignmentList = document.getElementById('assignment-list');
                const allAssignments = [...data.assignments.details.map(item => ({ name: item['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'], status: item['ì œì¶œìƒíƒœ'], date: new Date(item['Submitted at KST']), teacher_status: item['êµì‚¬í™•ì¸ìƒíƒœ'] || 'ë¯¸í™•ì¸' })), ...data.assignments.unsubmitted.map(item => ({ name: item.ê³¼ì œëª…, status: 'ë¯¸ì œì¶œ', date: new Date(item.ì œì¶œì¼ì‹œ.split('(')[0].replace(/(\d{2})/, '2025/')), teacher_status: '-' }))].sort((a, b) => b.date - a.date);
                if (allAssignments.length > 0) {
                    assignmentList.innerHTML = allAssignments.map(item => `<div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-start"><span class="font-semibold">${item.name}</span>${getStatusBadge(item.status, 'assignment')}</div><div class="text-sm text-gray-500 mt-1">${item.status !== 'ë¯¸ì œì¶œ' ? `<span>ì œì¶œ: ${item.date.toLocaleString('ko-KR')}</span> | <span>ìƒíƒœ: ${item.teacher_status}</span>` : `<span>ë§ˆê°: ${item.date.toLocaleDateString('ko-KR')}</span>`}</div></div>`).join('');
                } else { assignmentList.innerHTML = '<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; }

                const clinicSummary = data.clinic.summary;
                const clinicTotal = clinicSummary['ì´í´ë¦¬ë‹‰'] || 0;
                const clinicPresent = clinicSummary['ì •ìƒ'] || 0;
                const clinicLate = clinicSummary['ì§€ê°'] || 0;
                const clinicAbsent = clinicSummary['ê²°ì„'] || 0;
                const clinicAttended = clinicPresent + clinicLate;
                const clinicRate = Math.round((clinicAttended / clinicTotal || 0) * 100);
                document.getElementById('clinic-summary-text').innerHTML = `<span class="text-green-600">ì°¸ì„: ${clinicAttended}</span><span class="text-red-500 ml-2">ê²°ì„: ${clinicAbsent}</span>`;
                createDoughnutChart('clinic-chart', { 'ì°¸ì„': clinicAttended, 'ê²°ì„': clinicAbsent }, { 'ì°¸ì„': '#16a34a', 'ê²°ì„': '#dc2626' }, `${clinicRate}%`);
                const clinicList = document.getElementById('clinic-list');
                if (data.clinic.details.length > 0) {
                     clinicList.innerHTML = data.clinic.details.map(item => `<div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-center"><p class="font-semibold">${item.ë‚ ì§œ} <span class="text-sm text-gray-500 font-normal ml-2">(${item.ì¢…ë¥˜ || 'ì¼ë°˜'})</span></p>${getStatusBadge(item.ì¶œê²°, 'attendance')}</div></div>`).join('');
                } else { clinicList.innerHTML = '<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; }
                
                ['attendance', 'assignment', 'clinic'].forEach(section => {
                    const header = document.getElementById(`${section}-header`);
                    header.addEventListener('click', () => {
                        const container = header.nextElementSibling;
                        const arrow = header.querySelector('.toggle-arrow');
                        if (container.style.maxHeight) {
                            container.style.maxHeight = null;
                            arrow.style.transform = 'rotate(0deg)';
                        } else {
                            container.style.maxHeight = container.scrollHeight + "px";
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    });
                });

            } catch (error) {
                console.error("Error fetching data:", error);
                const errorMessage = `<p class="text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                ['attendance', 'assignment', 'clinic'].forEach(section => {
                    const header = document.getElementById(`${section}-header`);
                    if(header) { const container = header.nextElementSibling; if(container) container.innerHTML = errorMessage; }
                });
            } finally {
                loadingIndicator.style.display = 'none';
                appContainer.style.opacity = 1;
            }
            document.getElementById('logout-btn').addEventListener('click', () => {
                window.location.href = '/logout';
            });
        });
    </script>
</body>
</html>