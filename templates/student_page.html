<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-indicator" class="fixed inset-0 bg-white bg-opacity-75 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="flex justify-between items-center mb-8">
            <h1 id="student-name-header" class="text-3xl font-bold text-gray-900"></h1>
            <a href="/logout" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors">
                ë¡œê·¸ì•„ì›ƒ
            </a>
        </header>

        <main class="space-y-4">
            <div class="bg-white rounded-xl shadow-sm">
                <div class="accordion-header cursor-pointer p-6 flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center"><span class="mr-3 text-2xl">ğŸ—“ï¸</span>ì¶œê²° í˜„í™©</h2>
                    <span class="transform transition-transform duration-300">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 border-t">
                        <div class="md:col-span-1 flex flex-col items-center justify-center">
                             <div class="w-48 h-48"><canvas id="attendance-chart"></canvas></div>
                             <p class="mt-4 text-center text-gray-600 text-sm">ì´ ë“±ì›ì¼: <strong id="total-attendance-days" class="font-bold"></strong>ì¼</p>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-2">ìƒì„¸ ë‚´ì—­</h3>
                            <ul id="attendance-details" class="h-56 overflow-y-auto pr-2 space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm">
                <div class="accordion-header cursor-pointer p-6 flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center"><span class="mr-3 text-2xl">ğŸ“š</span>ê³¼ì œ ì œì¶œ í˜„í™©</h2>
                    <span class="transform transition-transform duration-300">â–¼</span>
                </div>
                <div class="accordion-content">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 border-t">
                        <div class="md:col-span-1 flex flex-col items-center justify-center">
                             <div class="w-48 h-48"><canvas id="assignment-chart"></canvas></div>
                             <p class="mt-4 text-center text-gray-600 text-sm">ì´ ê³¼ì œ: <strong id="total-assignments" class="font-bold"></strong>ê°œ</p>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-2">ìƒì„¸ ë‚´ì—­ (ìµœê·¼ ì œì¶œ ìˆœ)</h3>
                            <ul id="assignment-details" class="h-56 overflow-y-auto pr-2 space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm">
                <div class="accordion-header cursor-pointer p-6 flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center"><span class="mr-3 text-2xl">âœï¸</span>í´ë¦¬ë‹‰ í˜„í™©</h2>
                    <span class="transform transition-transform duration-300">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 border-t">
                        <div class="md:col-span-1 flex flex-col items-center justify-center">
                             <div class="w-48 h-48"><canvas id="clinic-chart"></canvas></div>
                              <p class="mt-4 text-center text-gray-600 text-sm">ì´ í´ë¦¬ë‹‰: <strong id="total-clinics" class="font-bold"></strong>íšŒ</p>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-2">ìƒì„¸ ë‚´ì—­</h3>
                            <ul id="clinic-details" class="h-56 overflow-y-auto pr-2 space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- DOM ìš”ì†Œ ---
    const loadingIndicator = document.getElementById('loading-indicator');
    const appContainer = document.getElementById('app');
    const studentNameHeader = document.getElementById('student-name-header');

    // --- ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ ---
    const renderData = (data) => {
        studentNameHeader.textContent = `${data.student_info.í•™ìƒì´ë¦„} í•™ìƒ ë¦¬í¬íŠ¸`;

        // 1. ì¶œê²° í˜„í™©
        const attendanceSummary = data.attendance.summary;
        const attendanceChartData = {
            labels: ['ì¶œì„', 'ì§€ê°', 'ê²°ì„', 'í™•ì¸ìš”ë§'],
            values: [
                attendanceSummary['ì¶œì„'] || 0,
                attendanceSummary['ì§€ê°'] || 0,
                attendanceSummary['ê²°ì„'] || 0,
                attendanceSummary['í™•ì¸ìš”ë§'] || 0
            ]
        };
        createDoughnutChart('attendance-chart', attendanceChartData.labels, attendanceChartData.values, "ì¶œê²° í˜„í™©");
        document.getElementById('total-attendance-days').textContent = attendanceSummary.ì´ì¼ìˆ˜ || 0;
        renderList('attendance-details', data.attendance.details, item => `
            <span class="font-semibold">${item.date}</span>
            <span class="font-bold ${getStatusColor(item.status)}">${item.status}</span>
        `);

        // 2. ê³¼ì œ í˜„í™©
        const assignmentSummary = data.assignments.summary;
        const assignmentChartData = {
            labels: ['ì •ìƒì œì¶œ', 'ì§€ê°ì œì¶œ', 'ë¯¸ì œì¶œ', 'ë°˜ë ¤'],
            values: [
                assignmentSummary['ì •ìƒì œì¶œ'] || 0,
                assignmentSummary['ì§€ê°ì œì¶œ'] || 0,
                assignmentSummary['ë¯¸ì œì¶œ'] || 0,
                assignmentSummary['ë°˜ë ¤'] || 0,
            ]
        };
        createDoughnutChart('assignment-chart', assignmentChartData.labels, assignmentChartData.values, "ê³¼ì œ í˜„í™©");
        document.getElementById('total-assignments').textContent = assignmentSummary.ì´ê³¼ì œ || 0;
        
        // ì œì¶œ + ë¯¸ì œì¶œ ëª©ë¡ í•©ì¹˜ê³  ì •ë ¬
        const allAssignments = [
            ...data.assignments.details.map(d => ({...d, type: 'ì œì¶œ'})),
            ...data.assignments.unsubmitted.map(d => ({...d, type: 'ë¯¸ì œì¶œ'}))
        ].sort((a, b) => {
            const dateA = a.type === 'ì œì¶œ' ? new Date(a['Submitted at KST']) : new Date(a['ì œì¶œì¼ì‹œ'].split(' ')[0]);
            const dateB = b.type === 'ì œì¶œ' ? new Date(b['Submitted at KST']) : new Date(b['ì œì¶œì¼ì‹œ'].split(' ')[0]);
            return dateB - dateA; // ìµœì‹ ìˆœ ì •ë ¬
        });

        renderList('assignment-details', allAssignments, item => {
             const name = item['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'] || item['ê³¼ì œëª…'];
             let status, statusColor;
             if (item.type === 'ì œì¶œ') {
                 status = item['êµì‚¬í™•ì¸ìƒíƒœ'] === 'ë°˜ë ¤' ? 'ë°˜ë ¤' : item['ì œì¶œìƒíƒœ'];
             } else {
                 status = 'ë¯¸ì œì¶œ';
             }
             return `
                <div class="flex-1">
                    <p class="font-semibold">${name}</p>
                    <p class="text-xs text-gray-500">${item.type === 'ì œì¶œ' ? new Date(item['Submitted at KST']).toLocaleString() : `ë§ˆê°: ${item.ì œì¶œì¼ì‹œ}`}</p>
                </div>
                <span class="font-bold ${getStatusColor(status)}">${status}</span>
             `
        });


        // 3. í´ë¦¬ë‹‰ í˜„í™©
        const clinicSummary = data.clinic.summary;
        const clinicChartData = {
            labels: ['ì°¸ì„', 'ë¶ˆì°¸'],
            values: [clinicSummary['ì°¸ì„'] || 0, clinicSummary['ë¶ˆì°¸'] || 0]
        };
        createDoughnutChart('clinic-chart', clinicChartData.labels, clinicChartData.values, "í´ë¦¬ë‹‰ í˜„í™©");
        document.getElementById('total-clinics').textContent = clinicSummary.ì´í´ë¦¬ë‹‰ || 0;
        renderList('clinic-details', data.clinic.details, item => `
            <div class="flex-1">
                <p class="font-semibold">${item.ë‚ ì§œ}</p>
                <p class="text-xs text-gray-500">ë‹´ë‹¹: ${item.ë‹´ë‹¹êµì‚¬ || 'ë¯¸ì§€ì •'}</p>
            </div>
            <span class="font-bold ${getStatusColor(item.ì¶œê²°)}">${item.ì¶œê²°}</span>
        `);
    };
    
    // --- í—¬í¼ í•¨ìˆ˜ ---
    const createDoughnutChart = (canvasId, labels, data, title) => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#22c55e', '#facc15', '#ef4444', '#f97316', '#a8a29e', '#64748b'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                    title: { display: false }
                },
                cutout: '60%'
            }
        });
    };
    
    const renderList = (elementId, items, templateFn) => {
        const listElement = document.getElementById(elementId);
        listElement.innerHTML = '';
        if (items.length === 0) {
            listElement.innerHTML = `<li class="text-center text-gray-500 py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
            return;
        }
        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
            li.innerHTML = templateFn(item);
            listElement.appendChild(li);
        });
    };

    const getStatusColor = (status) => {
        const colors = {
            'ì¶œì„': 'text-green-600', 'ì •ìƒì œì¶œ': 'text-green-600', 'ì°¸ì„': 'text-green-600',
            'ì§€ê°': 'text-yellow-600', 'ì§€ê°ì œì¶œ': 'text-yellow-600',
            'ê²°ì„': 'text-red-600', 'ë¯¸ì œì¶œ': 'text-red-600', 'ë¶ˆì°¸': 'text-red-600',
            'ë°˜ë ¤': 'text-orange-500',
            'í™•ì¸ìš”ë§': 'text-gray-500',
        };
        return colors[status] || 'text-gray-900';
    };


    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    const accordions = document.querySelectorAll('.accordion-header');
    accordions.forEach(accordion => {
        accordion.addEventListener('click', () => {
            const content = accordion.nextElementSibling;
            const arrow = accordion.querySelector('span');
            
            accordion.parentElement.classList.toggle('shadow-lg');
            arrow.classList.toggle('rotate-180');

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });

    // --- ë°ì´í„° ë¡œë”© ë° ì•± ì´ˆê¸°í™” ---
    try {
        const response = await fetch('/api/my_page_data');
        if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        const data = await response.json();
        renderData(data);
    } catch (error) {
        loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">ì˜¤ë¥˜ ë°œìƒ!</p><p class="text-gray-600 mt-2">${error.message}</p>`;
    } finally {
        loadingIndicator.classList.add('hidden');
        appContainer.classList.remove('hidden');
    }
});
</script>
</body>
</html>