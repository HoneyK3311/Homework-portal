<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ì œ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #888; border-radius: 10px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.2s ease-in-out; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 900px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s ease-in-out; max-height: 95vh; overflow-y: auto; }
        .modal-backdrop:not(.hidden) .modal-content { transform: scale(1); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .image-carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 10; transition: background-color 0.2s; }
        .image-carousel-btn:hover { background-color: rgba(0,0,0,0.8); }
        .image-carousel-btn:disabled { background-color: rgba(0,0,0,0.2); cursor: not-allowed; }
        #image-viewer { cursor: grab; }
        #image-viewer.grabbing { cursor: grabbing; }
        #submission-image { transition: transform 0.2s ease-out; transform-origin: center center; }
        .btn-loading { position: relative; color: transparent !important; }
        .btn-loading::after { content: ''; position: absolute; left: 50%; top: 50%; width: 20px; height: 20px; margin-left: -10px; margin-top: -10px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 0.6s linear infinite; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading-indicator" class="fixed inset-0 bg-white bg-opacity-75 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ê³¼ì œ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-600 mt-1">í•™ìƒë“¤ì˜ ê³¼ì œ ì œì¶œ í˜„í™©ì„ í•œëˆˆì— íŒŒì•…í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.</p>
        </header>

        <!-- í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="class-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="all">ì „ì²´ í´ë˜ìŠ¤</option></select>
                <select id="assignment-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="all">ì „ì²´ ê³¼ì œ</option></select>
                <select id="status-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="ë¯¸í™•ì¸">ë¯¸í™•ì¸ ê³¼ì œ</option>
                    <option value="all">ì „ì²´ (ë°˜ë ¤ ì œì™¸)</option>
                    <option value="í™•ì¸ì™„ë£Œ">í™•ì¸ì™„ë£Œ</option>
                    <option value="ë°˜ë ¤">ë°˜ë ¤ ë³´ê¸°</option>
                </select>
                <input type="text" id="student-search" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="í•™ìƒ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
            </div>
        </div>

        <!-- ê³¼ì œ ì œì¶œ í˜„í™© í…Œì´ë¸” -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í•™ìƒ ì´ë¦„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í´ë˜ìŠ¤</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê³¼ì œëª…</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œì¶œì¼ì‹œ (KST)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="submission-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ (ì±„ì  ê¸°ëŠ¥ í¬í•¨) -->
    <div id="detail-modal" class="modal-backdrop hidden">
        <div class="modal-content custom-scrollbar">
            <div class="flex flex-col space-y-4">
                <!-- ìƒë‹¨: ì´ë¯¸ì§€ ë·°ì–´ -->
                <div class="space-y-2">
                    <h3 class="text-lg font-semibold">ì œì¶œëœ ê³¼ì œ ì‚¬ì§„ (íœ : í™•ëŒ€/ì¶•ì†Œ, ë“œë˜ê·¸: ì´ë™)</h3>
                    <div class="relative">
                        <div id="image-viewer" class="w-full h-[60vh] bg-gray-900 rounded-md grid place-items-center overflow-hidden">
                            <img id="submission-image" src="" alt="ê³¼ì œ ì‚¬ì§„" class="object-contain">
                        </div>
                        <button id="prev-image-btn" class="image-carousel-btn left-2">â€¹</button>
                        <button id="next-image-btn" class="image-carousel-btn right-2">â€º</button>
                        <button id="rotate-image-btn" class="image-carousel-btn top-2 right-2 w-10 h-10 text-xl">ğŸ”„</button>
                        <div id="image-counter" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full"></div>
                    </div>
                </div>
                <!-- í•˜ë‹¨: ì •ë³´ ë° ì±„ì  ì˜ì—­ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold">í•™ìƒ ì •ë³´</h3>
                        <div class="p-3 bg-gray-100 rounded-md text-sm">
                            <p><strong>í•™ìƒ:</strong> <span id="modal-student-name"></span></p>
                            <p><strong>í´ë˜ìŠ¤:</strong> <span id="modal-class-name"></span></p>
                            <p><strong>ê³¼ì œ:</strong> <span id="modal-assignment-name"></span></p>
                            <p><strong>ì œì¶œì¼ì‹œ:</strong> <span id="modal-submission-date"></span></p>
                        </div>
                        <div>
                            <label for="feedback-notes" class="text-lg font-semibold">ë°˜ë ¤ ì‚¬ìœ  ë˜ëŠ” ë©”ëª¨</label>
                            <textarea id="feedback-notes" class="w-full p-2 mt-1 border rounded-md h-24" placeholder="ë°˜ë ¤ ì‹œ ì‚¬ìœ ë¥¼, í™•ì¸ ì™„ë£Œ ì‹œ ë©”ëª¨ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">í‹€ë¦° ë¬¸í•­ ì²´í¬</h3>
                        <div id="problem-list" class="p-2 border rounded-md bg-gray-50 h-48 overflow-y-auto custom-scrollbar grid grid-cols-5 gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row sm:justify-end sm:space-x-3 space-y-2 sm:space-y-0">
                <button id="modal-confirm-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">í™•ì¸ ì™„ë£Œ</button>
                <button id="modal-reject-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">ë°˜ë ¤</button>
                <button id="modal-close-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- ì „ì—­ ë³€ìˆ˜ ---
            let allSubmissions = [];
            let allAssignments = [];
            let currentSubmission = null;
            let currentImageIndex = 0;
            let currentImageUrls = [];
            
            let rotation = 0;
            let scale = 1;
            let isPanning = false;
            let startX = 0, startY = 0;
            let translateX = 0, translateY = 0;

            // --- DOM ìš”ì†Œ ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const appContainer = document.getElementById('app');
            const tableBody = document.getElementById('submission-table-body');
            const assignmentFilter = document.getElementById('assignment-filter');
            const classFilter = document.getElementById('class-filter');
            const statusFilter = document.getElementById('status-filter');
            const studentSearch = document.getElementById('student-search');
            
            const detailModal = document.getElementById('detail-modal');
            const modalStudentName = document.getElementById('modal-student-name');
            const modalClassName = document.getElementById('modal-class-name');
            const modalAssignmentName = document.getElementById('modal-assignment-name');
            const modalSubmissionDate = document.getElementById('modal-submission-date');
            const imageViewer = document.getElementById('image-viewer');
            const submissionImage = document.getElementById('submission-image');
            const problemList = document.getElementById('problem-list');
            const feedbackNotes = document.getElementById('feedback-notes');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalRejectBtn = document.getElementById('modal-reject-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const prevImageBtn = document.getElementById('prev-image-btn');
            const nextImageBtn = document.getElementById('next-image-btn');
            const imageCounter = document.getElementById('image-counter');
            const rotateImageBtn = document.getElementById('rotate-image-btn');

            // --- ë°ì´í„° ë¡œë”© ë° ì´ˆê¸°í™” ---
            async function fetchDataAndRender() {
                loadingIndicator.classList.remove('hidden');
                try {
                    const response = await fetch('/api/data');
                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    const data = await response.json();
                    allSubmissions = data.submissions;
                    allAssignments = data.assignments;
                    
                    if (classFilter.options.length <= 1) { // í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì±„ì›€
                        initializeFilters();
                    }
                    renderTable();
                } catch (error) {
                    loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!</p><p class="text-gray-600 mt-2">ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p><p class="text-sm text-gray-500 mt-1">${error.message}</p>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                }
            }

            function initializeFilters() {
                const classNames = [...new Set(allAssignments.map(a => a.í´ë˜ìŠ¤).filter(Boolean))];
                classNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    classFilter.appendChild(option);
                });

                const assignmentNames = [...new Set(allAssignments.map(a => a.ê³¼ì œëª…).filter(Boolean))];
                assignmentNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    assignmentFilter.appendChild(option);
                });
            }

            // âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„: ìƒíƒœ í‘œì‹œ ë¡œì§ ìˆ˜ì •
            function getStatusBadge(submission) {
                const teacherStatus = submission['êµì‚¬í™•ì¸ìƒíƒœ'] || 'ë¯¸í™•ì¸';
                
                const colors = {
                    "í™•ì¸ì™„ë£Œ": "bg-green-100 text-green-800",
                    "ë°˜ë ¤": "bg-red-100 text-red-800",
                    "ë¯¸í™•ì¸": "bg-gray-100 text-gray-800",
                };
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[teacherStatus] || colors['ë¯¸í™•ì¸']}">${teacherStatus}</span>`;
            }

            function renderTable() {
                tableBody.innerHTML = '';
                
                // í•„í„°ë§ ë¡œì§
                const classVal = classFilter.value;
                const assignmentVal = assignmentFilter.value;
                const statusVal = statusFilter.value;
                const searchVal = studentSearch.value.toLowerCase();

                let filteredSubmissions = allSubmissions.filter(s => {
                    const teacherStatus = s['êµì‚¬í™•ì¸ìƒíƒœ'] || 'ë¯¸í™•ì¸';
                    let isVisible = true;

                    if (statusVal === 'all') {
                        isVisible = teacherStatus !== 'ë°˜ë ¤';
                    } else {
                        isVisible = teacherStatus === statusVal;
                    }

                    const studentName = s['ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸° ê¸ˆì§€)'] || '';
                    const className = s['í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'] || '';
                    const assignmentName = s['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'] || '';

                    return isVisible &&
                           (classVal === 'all' || className === classVal) &&
                           (assignmentVal === 'all' || assignmentName === assignmentVal) &&
                           studentName.toLowerCase().includes(searchVal);
                });

                if (filteredSubmissions.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    return;
                }

                filteredSubmissions.forEach(s => {
                    const row = document.createElement('tr');
                    const studentName = s['ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸° ê¸ˆì§€)'] || 'ì´ë¦„ ì—†ìŒ';
                    const className = s['í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'] || 'í´ë˜ìŠ¤ ì—†ìŒ';
                    const assignmentName = s['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'] || 'ê³¼ì œëª… ì—†ìŒ';
                    const submissionDate = s['ì œì¶œì¼ì‹œ_KST_str'] || '-';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${studentName}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${className}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${assignmentName}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${submissionDate}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(s)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${s['Submission ID']}" class="detail-btn text-indigo-600 hover:text-indigo-900">ì±„ì í•˜ê¸°</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            [classFilter, assignmentFilter, statusFilter, studentSearch].forEach(el => {
                el.addEventListener('input', renderTable);
            });

            tableBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('detail-btn')) {
                    openGradingModal(e.target.dataset.id);
                }
            });

            function openGradingModal(submissionId) {
                currentSubmission = allSubmissions.find(s => s['Submission ID'] === submissionId);
                if (!currentSubmission) return alert('í•´ë‹¹ ì œì¶œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                const studentName = currentSubmission['ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸° ê¸ˆì§€)'] || 'ì´ë¦„ ì—†ìŒ';
                const className = currentSubmission['í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'] || 'í´ë˜ìŠ¤ ì—†ìŒ';
                const assignmentName = currentSubmission['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'] || 'ê³¼ì œëª… ì—†ìŒ';
                
                modalStudentName.textContent = studentName;
                modalClassName.textContent = className;
                modalAssignmentName.textContent = assignmentName;
                modalSubmissionDate.textContent = currentSubmission['ì œì¶œì¼ì‹œ_KST_str'] || '-';
                feedbackNotes.value = '';
                
                const imageUrlsString = currentSubmission['ê³¼ì œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.'] || "";
                currentImageUrls = imageUrlsString.split('https://').filter(Boolean).map(url => 'https://' + url.trim());
                currentImageIndex = 0;
                
                resetImageViewerState();
                updateImageViewer();

                problemList.innerHTML = '';
                const problems = allAssignments.filter(p => p.ê³¼ì œëª… === assignmentName && (p.í´ë˜ìŠ¤ === className || !p.í´ë˜ìŠ¤));
                if(problems.length > 0) {
                    problemList.className = 'p-2 border rounded-md bg-gray-50 h-48 overflow-y-auto custom-scrollbar grid grid-cols-5 gap-2';
                    problems.forEach(p => {
                        const problemId = `problem-${p.ë¬¸í•­ë²ˆí˜¸}`;
                        const problemDiv = document.createElement('div');
                        problemDiv.className = 'flex items-center justify-center p-1 border rounded-md hover:bg-gray-200 transition-colors';
                        problemDiv.innerHTML = `
                            <input id="${problemId}" type="checkbox" value="${p.ì›ë¬¸ë²ˆí˜¸}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${problemId}" class="ml-2 block text-sm text-gray-900 select-none cursor-pointer">${p.ë¬¸í•­ë²ˆí˜¸}</label>`;
                        problemList.appendChild(problemDiv);
                    });
                } else {
                    problemList.innerHTML = '<p class="text-gray-500 text-sm flex items-center justify-center h-full">í•´ë‹¹ ê³¼ì œì˜ ë¬¸í•­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

                detailModal.classList.remove('hidden');
            }

            function updateImageViewer() {
                if (currentImageUrls.length > 0) {
                    submissionImage.src = currentImageUrls[currentImageIndex];
                    [imageCounter, prevImageBtn, nextImageBtn, rotateImageBtn].forEach(el => el.classList.remove('hidden'));
                    imageCounter.textContent = `${currentImageIndex + 1} / ${currentImageUrls.length}`;
                } else {
                    submissionImage.src = 'https://placehold.co/800x600/e2e8f0/a0aec0?text=ì´ë¯¸ì§€ ì—†ìŒ';
                    [imageCounter, prevImageBtn, nextImageBtn, rotateImageBtn].forEach(el => el.classList.add('hidden'));
                }
                prevImageBtn.disabled = currentImageIndex === 0;
                nextImageBtn.disabled = currentImageIndex === currentImageUrls.length - 1;
                applyTransform();
            }

            function resetImageViewerState() {
                rotation = 0; scale = 1; translateX = 0; translateY = 0;
            }
            
            function resetImagePositionAndScale() {
                scale = 1; translateX = 0; translateY = 0;
            }

            function applyTransform() {
                submissionImage.style.transform = `translate(${translateX}px, ${translateY}px) rotate(${rotation}deg) scale(${scale})`;
            }
            
            prevImageBtn.addEventListener('click', () => {
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    resetImagePositionAndScale();
                    updateImageViewer();
                }
            });

            nextImageBtn.addEventListener('click', () => {
                if (currentImageIndex < currentImageUrls.length - 1) {
                    currentImageIndex++;
                    resetImagePositionAndScale();
                    updateImageViewer();
                }
            });

            rotateImageBtn.addEventListener('click', () => {
                rotation = (rotation + 90) % 360;
                applyTransform();
            });

            imageViewer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.001;
                const newScale = scale - e.deltaY * zoomIntensity;
                scale = Math.max(0.1, newScale);
                applyTransform();
            });

            imageViewer.addEventListener('mousedown', (e) => {
                e.preventDefault(); isPanning = true;
                startX = e.clientX - translateX; startY = e.clientY - translateY;
                imageViewer.classList.add('grabbing');
            });
            imageViewer.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                e.preventDefault();
                translateX = e.clientX - startX; translateY = e.clientY - startY;
                applyTransform();
            });
            imageViewer.addEventListener('mouseup', () => { isPanning = false; imageViewer.classList.remove('grabbing'); });
            imageViewer.addEventListener('mouseleave', () => { isPanning = false; imageViewer.classList.remove('grabbing'); });

            modalConfirmBtn.addEventListener('click', handleConfirm);
            modalRejectBtn.addEventListener('click', handleReject);

            async function handleApiRequest(action, payload) {
                const button = (action === 'confirm') ? modalConfirmBtn : modalRejectBtn;
                button.classList.add('btn-loading');
                button.disabled = true;

                try {
                    const response = await fetch('/api/update_status', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action, payload })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    alert(result.message);
                    closeGradingModal();
                    fetchDataAndRender(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                } finally {
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                }
            }

            function handleConfirm() {
                const checkedProblems = problemList.querySelectorAll('input[type="checkbox"]:checked');
                const wrongProblemTexts = Array.from(checkedProblems).map(cb => cb.value);

                const payload = {
                    submissionId: currentSubmission['Submission ID'],
                    className: currentSubmission['í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'],
                    studentName: currentSubmission['ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸° ê¸ˆì§€)'],
                    assignmentName: currentSubmission['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'],
                    submissionStatus: currentSubmission['ì œì¶œìƒíƒœ'],
                    totalProblems: problemList.querySelectorAll('input[type="checkbox"]').length,
                    wrongProblemCount: checkedProblems.length,
                    wrongProblemTexts: wrongProblemTexts,
                    memo: feedbackNotes.value
                };
                handleApiRequest('confirm', payload);
            }
            
            function handleReject() {
                if (!feedbackNotes.value.trim()) {
                    return alert('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                const payload = {
                    submissionId: currentSubmission['Submission ID'],
                    className: currentSubmission['í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'],
                    studentName: currentSubmission['ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸° ê¸ˆì§€)'],
                    assignmentName: currentSubmission['ê³¼ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë°˜ë“œì‹œ í™•ì¸ìš”ë§)'],
                    reason: feedbackNotes.value
                };
                handleApiRequest('reject', payload);
            }

            function closeGradingModal() {
                detailModal.classList.add('hidden');
            }

            modalCloseBtn.addEventListener('click', closeGradingModal);
            detailModal.addEventListener('click', e => {
                if (e.target === detailModal) closeGradingModal();
            });
            
            // ìµœì´ˆ ë°ì´í„° ë¡œë”©
            fetchDataAndRender();
        });
    </script>
</body>
</html>
