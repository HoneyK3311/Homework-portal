<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과제 관리 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #888; border-radius: 10px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.2s ease-in-out; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 900px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s ease-in-out; max-height: 95vh; overflow-y: auto; }
        .modal-backdrop:not(.hidden) .modal-content { transform: scale(1); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .image-carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 10; transition: background-color 0.2s; }
        .image-carousel-btn:hover { background-color: rgba(0,0,0,0.8); }
        .image-carousel-btn:disabled { background-color: rgba(0,0,0,0.2); cursor: not-allowed; }
        #image-viewer { cursor: grab; }
        #image-viewer.grabbing { cursor: grabbing; }
        #submission-image { transition: transform 0.2s ease-out; transform-origin: center center; }
        .btn-loading { position: relative; color: transparent !important; }
        .btn-loading::after { content: ''; position: absolute; left: 50%; top: 50%; width: 20px; height: 20px; margin-left: -10px; margin-top: -10px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 0.6s linear infinite; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 로딩 인디케이터 -->
    <div id="loading-indicator" class="fixed inset-0 bg-white bg-opacity-75 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">데이터를 불러오는 중입니다...</p>
    </div>

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">과제 관리 대시보드</h1>
            <p class="text-gray-600 mt-1">학생들의 과제 제출 현황을 한눈에 파악하고 관리하세요.</p>
        </header>

        <!-- 필터 및 검색 섹션 -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="class-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="all">전체 클래스</option></select>
                <select id="assignment-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="all">전체 과제</option></select>
                <select id="status-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="미확인">미확인 과제</option>
                    <option value="all">전체 (반려 제외)</option>
                    <option value="확인완료">확인완료</option>
                    <option value="반려">반려 보기</option>
                </select>
                <input type="text" id="student-search" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="학생 이름으로 검색...">
            </div>
        </div>

        <!-- 과제 제출 현황 테이블 -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학생 이름</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">클래스</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">과제명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제출일시 (KST)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                        </tr>
                    </thead>
                    <tbody id="submission-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 상세 정보 모달 (채점 기능 포함) -->
    <div id="detail-modal" class="modal-backdrop hidden">
        <div class="modal-content custom-scrollbar">
            <div class="flex flex-col space-y-4">
                <!-- 상단: 이미지 뷰어 -->
                <div class="space-y-2">
                    <h3 class="text-lg font-semibold">제출된 과제 사진 (휠: 확대/축소, 드래그: 이동)</h3>
                    <div class="relative">
                        <div id="image-viewer" class="w-full h-[60vh] bg-gray-900 rounded-md grid place-items-center overflow-hidden">
                            <img id="submission-image" src="" alt="과제 사진" class="object-contain">
                        </div>
                        <button id="prev-image-btn" class="image-carousel-btn left-2">‹</button>
                        <button id="next-image-btn" class="image-carousel-btn right-2">›</button>
                        <button id="rotate-image-btn" class="image-carousel-btn top-2 right-2 w-10 h-10 text-xl">🔄</button>
                        <div id="image-counter" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full"></div>
                    </div>
                </div>
                <!-- 하단: 정보 및 채점 영역 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold">학생 정보</h3>
                        <div class="p-3 bg-gray-100 rounded-md text-sm">
                            <p><strong>학생:</strong> <span id="modal-student-name"></span></p>
                            <p><strong>클래스:</strong> <span id="modal-class-name"></span></p>
                            <p><strong>과제:</strong> <span id="modal-assignment-name"></span></p>
                            <p><strong>제출일시:</strong> <span id="modal-submission-date"></span></p>
                        </div>
                        <div>
                            <label for="feedback-notes" class="text-lg font-semibold">반려 사유 또는 메모</label>
                            <textarea id="feedback-notes" class="w-full p-2 mt-1 border rounded-md h-24" placeholder="반려 시 사유를, 확인 완료 시 메모를 남길 수 있습니다."></textarea>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">틀린 문항 체크</h3>
                        <div id="problem-list" class="p-2 border rounded-md bg-gray-50 h-48 overflow-y-auto custom-scrollbar grid grid-cols-5 gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row sm:justify-end sm:space-x-3 space-y-2 sm:space-y-0">
                <button id="modal-confirm-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">확인 완료</button>
                <button id="modal-reject-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">반려</button>
                <button id="modal-close-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">닫기</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- 전역 변수 ---
            let allSubmissions = [];
            let allAssignments = [];
            let currentSubmission = null;
            let currentImageIndex = 0;
            let currentImageUrls = [];
            
            let rotation = 0;
            let scale = 1;
            let isPanning = false;
            let startX = 0, startY = 0;
            let translateX = 0, translateY = 0;

            // --- DOM 요소 ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const appContainer = document.getElementById('app');
            const tableBody = document.getElementById('submission-table-body');
            const assignmentFilter = document.getElementById('assignment-filter');
            const classFilter = document.getElementById('class-filter');
            const statusFilter = document.getElementById('status-filter');
            const studentSearch = document.getElementById('student-search');
            
            const detailModal = document.getElementById('detail-modal');
            const modalStudentName = document.getElementById('modal-student-name');
            const modalClassName = document.getElementById('modal-class-name');
            const modalAssignmentName = document.getElementById('modal-assignment-name');
            const modalSubmissionDate = document.getElementById('modal-submission-date');
            const imageViewer = document.getElementById('image-viewer');
            const submissionImage = document.getElementById('submission-image');
            const problemList = document.getElementById('problem-list');
            const feedbackNotes = document.getElementById('feedback-notes');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalRejectBtn = document.getElementById('modal-reject-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const prevImageBtn = document.getElementById('prev-image-btn');
            const nextImageBtn = document.getElementById('next-image-btn');
            const imageCounter = document.getElementById('image-counter');
            const rotateImageBtn = document.getElementById('rotate-image-btn');

            // --- 데이터 로딩 및 초기화 ---
            async function fetchDataAndRender() {
                loadingIndicator.classList.remove('hidden');
                try {
                    const response = await fetch('/api/data');
                    if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
                    const data = await response.json();
                    allSubmissions = data.submissions;
                    allAssignments = data.assignments;
                    
                    if (classFilter.options.length <= 1) { // 필터가 초기화되지 않았을 때만 채움
                        initializeFilters();
                    }
                    renderTable();
                } catch (error) {
                    loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">데이터 로딩 실패!</p><p class="text-gray-600 mt-2">백엔드 서버가 실행 중인지 확인해주세요.</p><p class="text-sm text-gray-500 mt-1">${error.message}</p>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                }
            }

            function initializeFilters() {
                const classNames = [...new Set(allAssignments.map(a => a.클래스).filter(Boolean))];
                classNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    classFilter.appendChild(option);
                });

                const assignmentNames = [...new Set(allAssignments.map(a => a.과제명).filter(Boolean))];
                assignmentNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    assignmentFilter.appendChild(option);
                });
            }

            // ✨ 수정된 부분: 상태 표시 로직 수정
            function getStatusBadge(submission) {
                const teacherStatus = submission['교사확인상태'] || '미확인';
                
                const colors = {
                    "확인완료": "bg-green-100 text-green-800",
                    "반려": "bg-red-100 text-red-800",
                    "미확인": "bg-gray-100 text-gray-800",
                };
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[teacherStatus] || colors['미확인']}">${teacherStatus}</span>`;
            }

            function renderTable() {
                tableBody.innerHTML = '';
                
                // 필터링 로직
                const classVal = classFilter.value;
                const assignmentVal = assignmentFilter.value;
                const statusVal = statusFilter.value;
                const searchVal = studentSearch.value.toLowerCase();

                let filteredSubmissions = allSubmissions.filter(s => {
                    const teacherStatus = s['교사확인상태'] || '미확인';
                    let isVisible = true;

                    if (statusVal === 'all') {
                        isVisible = teacherStatus !== '반려';
                    } else {
                        isVisible = teacherStatus === statusVal;
                    }

                    const studentName = s['이름을 입력해주세요. (띄어쓰기 금지)'] || '';
                    const className = s['클래스를 선택해주세요.'] || '';
                    const assignmentName = s['과제 번호를 선택해주세요. (반드시 확인요망)'] || '';

                    return isVisible &&
                           (classVal === 'all' || className === classVal) &&
                           (assignmentVal === 'all' || assignmentName === assignmentVal) &&
                           studentName.toLowerCase().includes(searchVal);
                });

                if (filteredSubmissions.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">표시할 데이터가 없습니다.</td></tr>`;
                    return;
                }

                filteredSubmissions.forEach(s => {
                    const row = document.createElement('tr');
                    const studentName = s['이름을 입력해주세요. (띄어쓰기 금지)'] || '이름 없음';
                    const className = s['클래스를 선택해주세요.'] || '클래스 없음';
                    const assignmentName = s['과제 번호를 선택해주세요. (반드시 확인요망)'] || '과제명 없음';
                    const submissionDate = s['제출일시_KST_str'] || '-';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${studentName}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${className}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${assignmentName}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${submissionDate}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(s)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${s['Submission ID']}" class="detail-btn text-indigo-600 hover:text-indigo-900">채점하기</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // --- 이벤트 리스너 ---
            [classFilter, assignmentFilter, statusFilter, studentSearch].forEach(el => {
                el.addEventListener('input', renderTable);
            });

            tableBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('detail-btn')) {
                    openGradingModal(e.target.dataset.id);
                }
            });

            function openGradingModal(submissionId) {
                currentSubmission = allSubmissions.find(s => s['Submission ID'] === submissionId);
                if (!currentSubmission) return alert('해당 제출 정보를 찾을 수 없습니다.');

                const studentName = currentSubmission['이름을 입력해주세요. (띄어쓰기 금지)'] || '이름 없음';
                const className = currentSubmission['클래스를 선택해주세요.'] || '클래스 없음';
                const assignmentName = currentSubmission['과제 번호를 선택해주세요. (반드시 확인요망)'] || '과제명 없음';
                
                modalStudentName.textContent = studentName;
                modalClassName.textContent = className;
                modalAssignmentName.textContent = assignmentName;
                modalSubmissionDate.textContent = currentSubmission['제출일시_KST_str'] || '-';
                feedbackNotes.value = '';
                
                const imageUrlsString = currentSubmission['과제 사진을 업로드해주세요.'] || "";
                currentImageUrls = imageUrlsString.split('https://').filter(Boolean).map(url => 'https://' + url.trim());
                currentImageIndex = 0;
                
                resetImageViewerState();
                updateImageViewer();

                problemList.innerHTML = '';
                const problems = allAssignments.filter(p => p.과제명 === assignmentName && (p.클래스 === className || !p.클래스));
                if(problems.length > 0) {
                    problemList.className = 'p-2 border rounded-md bg-gray-50 h-48 overflow-y-auto custom-scrollbar grid grid-cols-5 gap-2';
                    problems.forEach(p => {
                        const problemId = `problem-${p.문항번호}`;
                        const problemDiv = document.createElement('div');
                        problemDiv.className = 'flex items-center justify-center p-1 border rounded-md hover:bg-gray-200 transition-colors';
                        problemDiv.innerHTML = `
                            <input id="${problemId}" type="checkbox" value="${p.원문번호}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${problemId}" class="ml-2 block text-sm text-gray-900 select-none cursor-pointer">${p.문항번호}</label>`;
                        problemList.appendChild(problemDiv);
                    });
                } else {
                    problemList.innerHTML = '<p class="text-gray-500 text-sm flex items-center justify-center h-full">해당 과제의 문항 정보가 없습니다.</p>';
                }

                detailModal.classList.remove('hidden');
            }

            function updateImageViewer() {
                if (currentImageUrls.length > 0) {
                    submissionImage.src = currentImageUrls[currentImageIndex];
                    [imageCounter, prevImageBtn, nextImageBtn, rotateImageBtn].forEach(el => el.classList.remove('hidden'));
                    imageCounter.textContent = `${currentImageIndex + 1} / ${currentImageUrls.length}`;
                } else {
                    submissionImage.src = 'https://placehold.co/800x600/e2e8f0/a0aec0?text=이미지 없음';
                    [imageCounter, prevImageBtn, nextImageBtn, rotateImageBtn].forEach(el => el.classList.add('hidden'));
                }
                prevImageBtn.disabled = currentImageIndex === 0;
                nextImageBtn.disabled = currentImageIndex === currentImageUrls.length - 1;
                applyTransform();
            }

            function resetImageViewerState() {
                rotation = 0; scale = 1; translateX = 0; translateY = 0;
            }
            
            function resetImagePositionAndScale() {
                scale = 1; translateX = 0; translateY = 0;
            }

            function applyTransform() {
                submissionImage.style.transform = `translate(${translateX}px, ${translateY}px) rotate(${rotation}deg) scale(${scale})`;
            }
            
            prevImageBtn.addEventListener('click', () => {
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    resetImagePositionAndScale();
                    updateImageViewer();
                }
            });

            nextImageBtn.addEventListener('click', () => {
                if (currentImageIndex < currentImageUrls.length - 1) {
                    currentImageIndex++;
                    resetImagePositionAndScale();
                    updateImageViewer();
                }
            });

            rotateImageBtn.addEventListener('click', () => {
                rotation = (rotation + 90) % 360;
                applyTransform();
            });

            imageViewer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.001;
                const newScale = scale - e.deltaY * zoomIntensity;
                scale = Math.max(0.1, newScale);
                applyTransform();
            });

            imageViewer.addEventListener('mousedown', (e) => {
                e.preventDefault(); isPanning = true;
                startX = e.clientX - translateX; startY = e.clientY - translateY;
                imageViewer.classList.add('grabbing');
            });
            imageViewer.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                e.preventDefault();
                translateX = e.clientX - startX; translateY = e.clientY - startY;
                applyTransform();
            });
            imageViewer.addEventListener('mouseup', () => { isPanning = false; imageViewer.classList.remove('grabbing'); });
            imageViewer.addEventListener('mouseleave', () => { isPanning = false; imageViewer.classList.remove('grabbing'); });

            modalConfirmBtn.addEventListener('click', handleConfirm);
            modalRejectBtn.addEventListener('click', handleReject);

            async function handleApiRequest(action, payload) {
                const button = (action === 'confirm') ? modalConfirmBtn : modalRejectBtn;
                button.classList.add('btn-loading');
                button.disabled = true;

                try {
                    const response = await fetch('/api/update_status', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action, payload })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    alert(result.message);
                    closeGradingModal();
                    fetchDataAndRender(); // 데이터 새로고침
                } catch (error) {
                    alert(`오류 발생: ${error.message}`);
                } finally {
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                }
            }

            function handleConfirm() {
                const checkedProblems = problemList.querySelectorAll('input[type="checkbox"]:checked');
                const wrongProblemTexts = Array.from(checkedProblems).map(cb => cb.value);

                const payload = {
                    submissionId: currentSubmission['Submission ID'],
                    className: currentSubmission['클래스를 선택해주세요.'],
                    studentName: currentSubmission['이름을 입력해주세요. (띄어쓰기 금지)'],
                    assignmentName: currentSubmission['과제 번호를 선택해주세요. (반드시 확인요망)'],
                    submissionStatus: currentSubmission['제출상태'],
                    totalProblems: problemList.querySelectorAll('input[type="checkbox"]').length,
                    wrongProblemCount: checkedProblems.length,
                    wrongProblemTexts: wrongProblemTexts,
                    memo: feedbackNotes.value
                };
                handleApiRequest('confirm', payload);
            }
            
            function handleReject() {
                if (!feedbackNotes.value.trim()) {
                    return alert('반려 사유를 반드시 입력해주세요.');
                }
                const payload = {
                    submissionId: currentSubmission['Submission ID'],
                    className: currentSubmission['클래스를 선택해주세요.'],
                    studentName: currentSubmission['이름을 입력해주세요. (띄어쓰기 금지)'],
                    assignmentName: currentSubmission['과제 번호를 선택해주세요. (반드시 확인요망)'],
                    reason: feedbackNotes.value
                };
                handleApiRequest('reject', payload);
            }

            function closeGradingModal() {
                detailModal.classList.add('hidden');
            }

            modalCloseBtn.addEventListener('click', closeGradingModal);
            detailModal.addEventListener('click', e => {
                if (e.target === detailModal) closeGradingModal();
            });
            
            // 최초 데이터 로딩
            fetchDataAndRender();
        });
    </script>
</body>
</html>
